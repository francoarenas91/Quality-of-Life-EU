```{r}
rm(list = ls())

PAQUETES <- c("dplyr","tidyverse","ggplot2","eurostat","readxl")

for (el in PAQUETES){
  if (!require(el, character.only = TRUE)) {
    install.packages(el, repos = "https://cloud.r-project.org")
    require(el, character.only = TRUE)
  }
}
```

```{r}
query <-search_eurostat(pattern="demo_mlexpec",type='table')

query
```
```{r}
?get_eurostat()
```

##1. Material living conditions
Average rating of satisfaction by domain, sex, age and educational attainment level
```{r}
datasets=c("ilc_pw01","ilc_pw05")
EU_countries<-read_excel("./dictionaries/EU_countries.xlsx" ) %>% 
  rename(country_code=code,country_name=name)
EU_Countries_names_dict<- setNames(EU_countries$country_name, EU_countries$country_code)

data_01 <-get_eurostat(datasets[1],
                    filters=list(geo=pull(EU_countries,country_code))) #read data for the 27 only
data_02 <-get_eurostat(datasets[2],
                    filters=list(geo=pull(EU_countries,country_code))) #read data for the 27 only

# join both datasets
data_02 %>% 
  pivot_wider(names_from="lev_satis",values_from = "values",names_prefix="share_") %>% 
  select(-unit) %>% 
  full_join(data_01,by=c("freq","isced11","indic_wb","sex","age","geo","time"),keep = F) ->data

sheets=c("age","isced11","indic_wb")
for (sheet in sheets) {
  dict <-read_excel(paste0("./dictionaries/",dataset,".xlsx"),sheet=sheet)
  replacement_dict <- setNames(dict$name, dict$code)
  data <- data %>% 
  mutate(!!sym(sheet) := recode(!!sym(sheet), !!!replacement_dict))
  ##!!! splits a vector into individual arguments for a function
  ## !!sym() is a way to convert the string sheet into a symbol that dplyr can understand as a column name.
}

data %>% 
  mutate(
    sex = recode(sex,"F"="Female","M"="Male","T"="Total"),
    country_name =recode(geo,!!!EU_Countries_names_dict)
    ) %>% 
  select(-c(freq,unit)) %>% 
  rename(indicator=indic_wb,
         education=isced11) -> exporting_data

save(exporting_data, file = paste0("./data/","satisfaction", ".RData"))

```

income of households, regional  
```{r}
dataset="nama_10r_2hhinc"
NUTS2<-read_excel("./dictionaries/NUTS2.xlsx" ) %>% 
  rename(geo=code)

data <-get_eurostat(dataset)
data %>% 
  mutate(country_code=substr(geo,1,2)) %>% 
  filter(country_code %in% EU_countries$country_code) %>% 
  filter(nchar(geo)==4) %>%   #only nuts 2 regions
  filter(direct=="BAL") %>%  #balance
  filter(unit=="EUR_HAB") %>% #eur per habitant
  filter(na_item=="B5N") %>% #income 
  left_join(NUTS2,by="geo") %>% 
  left_join(EU_countries,by=c("country_code")) %>% 
  mutate(year = year(TIME_PERIOD)) %>% 
  select(-c(freq,unit,direct,na_item,TME_PERIOD)) 

  

data %>% select(na_item) %>% unique()
```

level of satisfaction by domain, sex, age and educational attainment level
```{r}
dataset="ilc_pw05"

data <-get_eurostat(dataset)

EU_countries<-read_excel("./dictionaries/EU_countries.xlsx" ) %>% 
  rename(country_code=code,country_name=name)
EU_Countries_names_dict<- setNames(EU_countries$country_name, EU_countries$country_code)

data <-get_eurostat(dataset,
                    filters=list(geo=pull(EU_countries,country_code))) #read data for the 27 only

sheets=c("age","isced11","indic_wb")
for (sheet in sheets) {
  dict <-read_excel(paste0("./dictionaries/",dataset,".xlsx"),sheet=sheet)
  replacement_dict <- setNames(dict$name, dict$code)
  data <- data %>% 
  mutate(!!sym(sheet) := recode(!!sym(sheet), !!!replacement_dict))
  ##!!! splits a vector into individual arguments for a function
  ## !!sym() is a way to convert the string sheet into a symbol that dplyr can understand as a column name.
}

data %>% 
  mutate(
    sex = recode(sex,"F"="Female","M"="Male","T"="Total")
    ) %>% 
  select(-c(freq,unit)) %>% 
  rename(indicator=indic_wb,
         education=isced11) -> exporting_data

save(exporting_data, file = paste0("./data/", dataset, ".RData"))
```

